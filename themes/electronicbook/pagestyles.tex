%%%%%%%%%%%% Définition des styles de page

\fancypagestyle{chapterstart}{% 1ère page des chapitres
	\fancyhf{}%
  	\fancyfoot[RO,RE]{%
  	%\vskip0.1pt
  	\begin{tikzpicture}
  	\node[rounded corners=3pt,fill=shadow@color,inner ysep=5pt, inner xsep=2ex,text=shadow@color] (shadow) {\pagenumber@font\thepage};
  	\node[rounded corners=3pt,fill=pagenumber@bg@color,inner ysep=5pt, inner xsep=2ex,text=white] at ($(shadow)+(-2pt,2pt)$) {\pagenumber@font\thepage};
  	\end{tikzpicture}
  	}
}

\fancypagestyle{toc}{% Sommaire
	\fancyhf{}%
  	\fancyfoot{}
}

\fancypagestyle{main}{% 
	\fancyhf{}%
  	\fancyfoot[RO]{% pages impaires
  	\ClearShipoutPicture
	  %\vskip0.1pt 
  	\begin{tikzpicture}
  	\node[rounded corners=3pt,fill=shadow@color,inner ysep=5pt, inner xsep=2ex,text=shadow@color] (shadow) {\pagenumber@font\thepage};
  	\node[rounded corners=3pt,fill=pagenumber@bg@color,inner ysep=5pt, inner xsep=2ex,text=white] at ($(shadow)+(-2pt,2pt)$) {\pagenumber@font\thepage};
  	\end{tikzpicture}
  	}
  	\fancyfoot[LE]{% pages paires	
  		\ClearShipoutPicture
  		%\vskip0.1pt
  		\begin{tikzpicture}
  		\node[rounded corners=3pt,fill=shadow@color,inner ysep=5pt, inner xsep=2ex,text=shadow@color] (shadow) {\pagenumber@font\thepage};
  		\node[rounded corners=3pt,fill=pagenumber@bg@color,inner ysep=5pt, inner xsep=2ex,text=white] at ($(shadow)+(2pt,2pt)$) {\pagenumber@font\thepage};
  		\end{tikzpicture}
  	}
}

%%%%%%%%%%%% En-tête et pied de page

\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\pagestyle{main}

%%%%%%%%%%%% Définitions par défaut
\newcommand{\intro}[1]{\def\chapterintro{#1}}
\newcommand{\introauthor}[1]{\def\chapterintroauthor{#1}}
\introauthor{} % auteur de la citation en début de chapitre
\intro{} % Citation en début de chapitre ; à déclarer avant la commande \chapter{}


%%%%%%%%%%%% Page de présentation

%%%%%%%%%%%% Première page de chaque chapitre

	%\thispagestyle{chapterstart}
	%\pagecolor{white}
	%\bfseries\Huge\raggedleft
	%\color{chapter@title@color}
	%\chaptertitle@font


\titleformat{\chapter}
	{
	%\gdef\chapterlabel{} \normalfont\sffamily\Large\bfseries
	\thispagestyle{chapterstart}
	\pagecolor{white}
	\bfseries\LARGE\raggedleft
	\color{chapter@title@color}
	%\chaptertitle@font
	}
	{\gdef\chapterlabel{\thechapter)\ }}{7ex}
	{\formatchapter}

\newcommand{\formatchapter}[1]{%
	\begin{tikzpicture}[remember picture,overlay]
		\node[xshift=2.25cm, yshift=-2cm] at (current page.north west) {\includegraphics[scale=.078]{common/themes/electronicbook/uimm.png}};
		\node[yshift=-3cm, yshift=-0.25cm] at (current page.north west)
		{\begin{tikzpicture}[remember picture, overlay]
		%\draw[fill=easi@light@blue, rounded corners=12pt] (4.3,0) rectangle (.97\paperwidth,2.5cm);
		%\node[anchor=west,xshift=4.3cm,yshift=1.25cm, rectangle, rounded corners=12pt,inner sep=30pt, fill=easi@light@blue, minimum width=.76\paperwidth] {\color{white}\thechapter~-~\chaptername};
		%\node[anchor=west,xshift=4.3cm,yshift=1.25cm, rectangle, rounded corners=12pt,inner sep=30pt, fill=easi@light@blue, minimum width=.76\paperwidth] {\color{white}\chapterlabel#1};
		\node[anchor=west,xshift=4.3cm,yshift=1.25cm, rectangle, rounded corners=12pt,inner sep=30pt, fill=easi@default@blue, minimum width=.76\paperwidth] {\color{white}\thechapter~-~#1};
		\end{tikzpicture}
		};
	\end{tikzpicture}
}
  
\titlespacing*{\chapter}{0pt}{64pt}{-20pt}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%% Tables des matières %%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\addto\captionsfrench{\renewcommand{\contentsname}{Sommaire}}

\newcommand{\chaptertoccolor}{white}
\newcommand{\sectiontoccolor}{section@title@color}
\newcommand{\subsectiontoccolor}{subsection@title@color}
\newcommand{\subsubsectiontoccolor}{subsubsection@title@color}

\renewcommand*\l@chapter[2]
{%
  \ifnum\c@tocdepth>\m@ne
    \addpenalty{-\@highpenalty}%
    \vskip 1.0em \@plus\p@
    \setlength\@tempdima{1.5em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode \bfseries \chaptertitle@font \large
      \advance\leftskip\@tempdima
      \hskip -\leftskip
      \def\@linkcolor{\chaptertoccolor}%
      \raisebox{-0.6em}{%
      \begin{tikzpicture}%
      \node[rounded corners=2pt,fill=chapter@title@color,text=white, xslant=0.2] {#1};
      \end{tikzpicture}%
      }
      \color{chapter@title@color}
      \nobreak\
       \leaders\hbox{$\m@th
        \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
        mu$}\hfil\nobreak\hb@xt@\@pnumwidth{\hss
        \def\@linkcolor{chapter@title@color}%
        \color{\chaptertoccolor}#2}\par
      \penalty\@highpenalty
    \endgroup
  \fi
  \medskip
}

%\def\@dottedtocline#1#2#3#4#5
%{%
%    \vskip \z@ \@plus.2\p@
%    {%
%     \leftskip#2\relax\rightskip\@tocrmarg\parfillskip-\rightskip
%     \parindent #2\relax\@afterindenttrue
%     \interlinepenalty\@M
%     \leavevmode
%     \@tempdima #3\relax
%     \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
%     {%
%     	\sectiontitle@font#4
%     }
%     \nobreak\sectiontitle@font
%     \leaders\hbox{$\m@th
%        \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
%        mu$}\hfill
%     \nobreak
%     \hb@xt@\@pnumwidth{\hfil #5}%
%     \par}%
%}
  
\renewcommand*\l@section{%
\color{\sectiontoccolor}
\def\@linkcolor{\sectiontoccolor}
\@dottedtocline{1}{0em}{2em}
}

\renewcommand*\l@subsection{%
\color{\subsectiontoccolor}
\def\@linkcolor{\subsectiontoccolor}
\@dottedtocline{1}{2em}{2em}
}

\renewcommand*\l@subsubsection{%
\color{\subsubsectiontoccolor}
\def\@linkcolor{\subsubsectiontoccolor}
\@dottedtocline{1}{4em}{2em}
}

\def\contentsline#1#2#3#4{%
  \ifx\\#4\\%
    \csname l@#1\endcsname{#2}{#3}%
  \else
      \csname l@#1\endcsname{\hyper@linkstart{link}{#4}{#2}\hyper@linkend}{%
        \hyper@linkstart{link}{#4}{#3}\hyper@linkend
      }%
  \fi
}

%%%%%%%%%%%%%%% Page de garde

\def\coef@bg@pic{1.05}
\def\coef@opacity@pic{0.2}
\newcommand{\titlepic}[2][1]{%
	\FPeval\newscale{\coef@bg@pic*#1}
	\def\@titlepic{\includegraphics[scale=#1]{#2}}
	\def\@titlepicbg{\includegraphics[scale=\newscale]{#2}}
}
\renewcommand{\and}{\par}

\renewcommand{\maketitle}
{%
	\newgeometry{margin=0pt}
	\begin{tikzpicture}
	\clip (current page.south west) rectangle (current page.north east);
	% Fond en dégradé
	\shade[top color=firstpagetop@bg@color,bottom color=firstpagebottom@bg@color] (current page.south west) rectangle (current page.north east);
	% Traits horizontaux et verticaux
	\foreach \y in {1,2,...,10}
	{
		\draw[color=firstpage@lines@color] ($(current page.north west)+(0,-\y*0.5)$) -- ($(current page.north east)+(-0.125*\y,-0.5*\y)$);
		\draw[color=firstpage@lines@color] ($(current page.north west)+(\y*0.5,0)$) -- ($(current page.north west)+(0,-\y)$);
	}
	% Titre
	\node[below right,text=titledoc@color] at ($(current page.north west)+(\marginlefttitle,-\margintoptitle)$) {\begin{minipage}{\dimexpr\paperwidth-2\marginlefttitle}\titledoc@font\@title\end{minipage}};
	% Auteur(s)
	\node[below left,text=titleauthor@color] at ($(current page.north east)+(-\marginlefttitle,-\margintopauthor)$) {%
	\begin{minipage}{\dimexpr\paperwidth-2\marginlefttitle}
	\raggedleft
	\titleauthor@font\@author
	\end{minipage}};
	% Image (facultatif)
	\ifx\titlepic\@empty\else
		\node[above left] (pic) at ($(current page.south east)+(-\marginrightpic,\marginbottompic)$) {\@titlepic};
		\node[opacity=\coef@opacity@pic] at (pic.center) {\@titlepicbg};
		\node[above left] (pic) at ($(current page.south east)+(-\marginrightpic,\marginbottompic)$) {\@titlepic};
	\fi
	% Date
	\node[left,text=titledate@color] at ($0.5*(current page.north east)+0.5*(current page.south east)+(-\marginrightdate,\marginbottomdate)$) {\titledate@font\@date};
	\end{tikzpicture}
	\if@openany
	\else
		\cleardoublepage
	\fi
	\restoregeometry
}
